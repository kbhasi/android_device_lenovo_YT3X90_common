#include <linux/input/ist520e.h>

#define ISTXXXX_IMAGE_DELAY	600
#define ISTCORE_RESET_IC_DELAY	500
#define HIDEEP_SELFTEST_RETRY_TIME 5
#define TEST_MODE_COMMAND_ADDR 0x0804
#define HIDEEP_IMAGE_HEAD_LEN   4
#define HIDEEP_IMAGE_CMD_4RC    0
#define HIDEEP_IMAGE_CMD_1RC    1
#define HIDEEP_IMAGE_CMD_EOP    2
#define HIDEEP_IMAGE_CMD_4RCF   3

const unsigned char ISTXXXX_GIS_CMP_TYPICAL_SPEC[TX_NUM*RX_NUM] = {
99,99,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,97,97,98,98,97,97,97,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,
97,97,97,97,96,97,97,97,97,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,97,96,97,96,96,96,96,97,97,97,97,97,97,97,97,97,97,97,97,97,
96,96,96,96,96,96,96,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,96,96,96,96,96,96,96,96,97,96,97,96,
95,95,95,95,95,95,95,94,95,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,95,95,95,95,95,95,95,95,95,96,96,96,96,96,96,
94,94,94,94,94,94,94,94,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,94,94,94,94,94,94,95,95,95,95,96,96,
93,94,93,93,93,93,93,93,92,92,92,92,92,92,92,92,92,91,91,91,92,92,91,91,92,91,91,91,92,92,92,92,92,92,92,92,92,92,92,92,93,93,93,93,93,93,94,94,94,94,95,95,
93,93,92,92,92,92,92,92,92,91,91,91,91,91,91,91,91,91,90,90,91,90,90,91,91,91,90,91,91,91,91,91,91,91,91,91,91,91,92,92,92,92,92,92,93,93,93,93,94,94,94,94,
92,92,92,92,91,91,91,91,91,90,90,90,90,90,90,90,90,90,90,89,90,90,89,89,90,89,89,90,90,90,90,90,90,90,90,90,90,90,91,91,91,91,91,92,92,92,93,93,93,93,93,93,
91,91,91,91,91,90,90,90,90,89,89,89,89,89,89,89,89,89,89,89,89,89,88,88,89,89,88,89,89,89,89,89,89,89,89,89,90,90,90,90,90,91,91,91,91,91,92,92,92,92,93,92,
91,91,90,90,90,90,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,87,88,88,88,87,88,88,88,88,88,88,88,89,88,89,89,89,89,89,90,90,90,90,90,91,91,92,92,92,92,
90,90,90,89,89,89,89,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,88,88,88,89,89,89,89,90,90,90,90,91,91,92,91,
89,89,89,89,88,88,88,88,87,87,87,87,87,87,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,87,87,87,87,87,87,88,88,88,89,89,89,90,90,90,90,91,91,
89,89,88,88,88,87,87,87,87,86,86,86,86,86,85,85,86,85,85,85,85,85,85,85,85,85,85,85,85,85,85,85,86,86,86,86,86,86,86,87,87,87,87,88,88,88,89,89,89,90,90,90,
88,88,88,87,87,87,86,86,86,85,85,85,85,85,85,85,85,84,84,84,84,84,84,84,84,84,84,84,84,84,84,85,85,85,85,85,85,86,86,86,86,87,87,87,88,88,88,88,89,89,90,90,
87,87,87,87,86,86,86,85,85,85,85,85,85,84,84,84,84,84,83,83,84,83,83,83,83,83,83,83,83,84,84,84,84,84,84,84,85,85,85,85,86,86,86,87,87,87,88,88,88,89,89,89,
87,87,86,86,86,85,85,85,85,84,84,84,84,83,83,83,83,83,83,83,83,83,82,82,83,83,82,83,83,83,83,83,83,83,84,83,84,84,84,84,85,85,86,86,87,86,87,87,88,88,89,89,
86,86,86,86,85,85,85,84,84,84,84,83,83,83,82,83,83,82,82,82,82,82,82,82,82,82,82,82,82,82,82,82,83,83,83,83,83,83,84,84,84,85,85,86,86,86,87,87,87,87,88,89,
86,86,85,85,85,84,84,84,84,83,83,83,83,82,82,82,82,82,81,81,81,81,81,81,81,81,81,81,81,82,81,82,82,82,82,82,83,83,83,83,84,84,84,85,85,85,86,86,87,87,88,88,
85,85,85,85,84,84,83,83,83,82,82,82,82,82,81,81,81,81,81,81,81,81,81,80,80,81,81,81,81,81,81,81,81,81,82,82,82,82,82,83,83,84,84,84,85,85,86,86,86,87,87,87,
85,85,84,84,84,83,83,83,82,82,82,81,81,81,81,81,81,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,81,81,81,81,82,82,82,82,83,83,83,84,84,84,85,86,86,86,87,87,
85,85,84,84,83,83,83,82,82,81,81,81,81,80,80,80,80,80,80,80,80,80,80,79,80,80,79,80,80,80,80,80,81,80,81,81,81,81,81,82,83,83,83,83,84,84,85,85,86,86,87,86,
84,84,84,84,83,83,82,82,82,81,81,81,81,80,80,80,80,80,79,79,79,79,79,79,79,79,79,79,79,80,79,80,80,80,80,80,81,81,81,81,82,83,83,83,84,84,85,85,85,86,86,86,
84,84,83,83,83,82,82,81,81,81,81,80,80,80,79,79,79,79,79,79,79,79,79,78,79,79,79,79,79,79,79,79,80,79,80,80,80,80,81,81,82,82,82,83,83,83,84,85,85,85,86,86,
84,84,83,83,82,82,81,81,81,80,80,80,80,79,79,79,79,79,78,78,78,78,78,78,78,78,78,78,78,79,79,79,79,79,80,79,80,80,80,81,81,82,82,82,83,83,84,84,85,85,85,85,
83,83,83,82,82,82,81,81,81,80,80,80,79,79,79,79,79,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,79,78,79,79,80,80,80,80,81,81,81,82,82,82,83,84,84,85,85,85,
83,83,83,82,82,82,81,81,81,80,80,79,79,79,78,78,78,78,78,78,78,78,78,77,78,77,78,78,78,78,78,78,78,78,79,79,79,79,80,80,81,81,81,82,82,82,83,83,84,84,85,85,
83,83,82,82,82,81,81,80,80,79,79,79,79,78,78,78,78,78,77,77,78,77,77,77,77,77,77,77,77,78,78,78,78,78,79,78,79,79,79,80,80,81,81,82,82,82,83,83,84,84,85,85,
83,83,82,82,82,81,81,80,80,79,79,79,79,78,78,78,78,77,77,77,78,77,77,77,77,77,77,77,77,77,77,78,78,78,78,78,79,79,79,80,80,81,81,81,82,82,83,83,84,84,85,85,
83,83,82,82,81,81,81,80,80,79,79,79,79,78,78,78,78,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,78,78,78,78,79,79,79,80,80,81,81,81,82,82,83,83,84,84,85,85,
83,83,82,82,81,81,80,80,80,79,79,79,79,78,78,78,78,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,78,77,78,78,78,79,79,79,80,80,80,81,82,82,83,83,84,84,84,85,
83,83,82,82,81,81,80,80,80,79,79,79,79,78,78,77,77,77,77,77,77,77,76,76,76,76,76,77,76,77,77,77,77,77,78,77,78,78,78,79,79,80,80,81,81,81,83,83,83,84,84,85,
83,83,82,82,81,81,80,80,80,79,79,78,78,78,77,77,77,77,76,76,77,76,76,76,76,76,76,76,76,76,76,76,77,77,77,77,78,78,78,79,79,80,80,80,81,81,82,82,83,83,84,84
};

const short GIS_4RCF_SPEC[TX_NUM] = {
1782,1989,2011,2014,2011,2000,1997,1992,1989,1986,1996,1993,1989,1984,1981,1977,1971,1964,1939,1931,1929,1941,1942,1944,1944,1943,1929,1927,1927,1924,1922,1824
};

const short GIS_EOP_SPEC[RX_NUM] = {
1570,1731,1700,1725,1700,1714,1692,1707,1690,1703,1681,1693,1680,1687,1670,1687,1666,1679,1659,1667,1648,1662,1645,1662,1643,1650,1632,1650,1630,1639,1630,1631,1624,1625,1624,1627,1609,1617,1603,1608,1601,1596,1593,1597,1589,1594,1581,1588,1574,1577,1575,1490 
};


const unsigned char ISTXXXX_OFILM_CMP_TYPICAL_SPEC[TX_NUM*RX_NUM] = {
99,99,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,97,97,98,98,97,97,97,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,98,
97,97,97,97,96,97,97,97,97,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,97,96,97,96,96,96,96,97,97,97,97,97,97,97,97,97,97,97,97,97,
96,96,96,96,96,96,96,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,95,96,96,96,96,96,96,96,96,97,96,97,96,
95,95,95,95,95,95,95,94,95,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,94,95,95,95,95,95,95,95,95,95,96,96,96,96,96,96,
94,94,94,94,94,94,94,94,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,93,94,94,94,94,94,94,95,95,95,95,96,96,
93,94,93,93,93,93,93,93,92,92,92,92,92,92,92,92,92,91,91,91,92,92,91,91,92,91,91,91,92,92,92,92,92,92,92,92,92,92,92,92,93,93,93,93,93,93,94,94,94,94,95,95,
93,93,92,92,92,92,92,92,92,91,91,91,91,91,91,91,91,91,90,90,91,90,90,91,91,91,90,91,91,91,91,91,91,91,91,91,91,91,92,92,92,92,92,92,93,93,93,93,94,94,94,94,
92,92,92,92,91,91,91,91,91,90,90,90,90,90,90,90,90,90,90,89,90,90,89,89,90,89,89,90,90,90,90,90,90,90,90,90,90,90,91,91,91,91,91,92,92,92,93,93,93,93,93,93,
91,91,91,91,91,90,90,90,90,89,89,89,89,89,89,89,89,89,89,89,89,89,88,88,89,89,88,89,89,89,89,89,89,89,89,89,90,90,90,90,90,91,91,91,91,91,92,92,92,92,93,92,
91,91,90,90,90,90,89,89,89,89,89,89,89,88,88,88,88,88,88,88,88,88,87,88,88,88,87,88,88,88,88,88,88,88,89,88,89,89,89,89,89,90,90,90,90,90,91,91,92,92,92,92,
90,90,90,89,89,89,89,88,88,88,88,88,88,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,87,88,87,88,88,88,88,89,89,89,89,90,90,90,90,91,91,92,91,
89,89,89,89,88,88,88,88,87,87,87,87,87,87,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,86,87,87,87,87,87,87,88,88,88,89,89,89,90,90,90,90,91,91,
89,89,88,88,88,87,87,87,87,86,86,86,86,86,85,85,86,85,85,85,85,85,85,85,85,85,85,85,85,85,85,85,86,86,86,86,86,86,86,87,87,87,87,88,88,88,89,89,89,90,90,90,
88,88,88,87,87,87,86,86,86,85,85,85,85,85,85,85,85,84,84,84,84,84,84,84,84,84,84,84,84,84,84,85,85,85,85,85,85,86,86,86,86,87,87,87,88,88,88,88,89,89,90,90,
87,87,87,87,86,86,86,85,85,85,85,85,85,84,84,84,84,84,83,83,84,83,83,83,83,83,83,83,83,84,84,84,84,84,84,84,85,85,85,85,86,86,86,87,87,87,88,88,88,89,89,89,
87,87,86,86,86,85,85,85,85,84,84,84,84,83,83,83,83,83,83,83,83,83,82,82,83,83,82,83,83,83,83,83,83,83,84,83,84,84,84,84,85,85,86,86,87,86,87,87,88,88,89,89,
86,86,86,86,85,85,85,84,84,84,84,83,83,83,82,83,83,82,82,82,82,82,82,82,82,82,82,82,82,82,82,82,83,83,83,83,83,83,84,84,84,85,85,86,86,86,87,87,87,87,88,89,
86,86,85,85,85,84,84,84,84,83,83,83,83,82,82,82,82,82,81,81,81,81,81,81,81,81,81,81,81,82,81,82,82,82,82,82,83,83,83,83,84,84,84,85,85,85,86,86,87,87,88,88,
85,85,85,85,84,84,83,83,83,82,82,82,82,82,81,81,81,81,81,81,81,81,81,80,80,81,81,81,81,81,81,81,81,81,82,82,82,82,82,83,83,84,84,84,85,85,86,86,86,87,87,87,
85,85,84,84,84,83,83,83,82,82,82,81,81,81,81,81,81,80,80,80,80,80,80,80,80,80,80,80,80,80,80,80,81,81,81,81,82,82,82,82,83,83,83,84,84,84,85,86,86,86,87,87,
85,85,84,84,83,83,83,82,82,81,81,81,81,80,80,80,80,80,80,80,80,80,80,79,80,80,79,80,80,80,80,80,81,80,81,81,81,81,81,82,83,83,83,83,84,84,85,85,86,86,87,86,
84,84,84,84,83,83,82,82,82,81,81,81,81,80,80,80,80,80,79,79,79,79,79,79,79,79,79,79,79,80,79,80,80,80,80,80,81,81,81,81,82,83,83,83,84,84,85,85,85,86,86,86,
84,84,83,83,83,82,82,81,81,81,81,80,80,80,79,79,79,79,79,79,79,79,79,78,79,79,79,79,79,79,79,79,80,79,80,80,80,80,81,81,82,82,82,83,83,83,84,85,85,85,86,86,
84,84,83,83,82,82,81,81,81,80,80,80,80,79,79,79,79,79,78,78,78,78,78,78,78,78,78,78,78,79,79,79,79,79,80,79,80,80,80,81,81,82,82,82,83,83,84,84,85,85,85,85,
83,83,83,82,82,82,81,81,81,80,80,80,79,79,79,79,79,78,78,78,78,78,78,78,78,78,78,78,78,78,78,78,79,78,79,79,80,80,80,80,81,81,81,82,82,82,83,84,84,85,85,85,
83,83,83,82,82,82,81,81,81,80,80,79,79,79,78,78,78,78,78,78,78,78,78,77,78,77,78,78,78,78,78,78,78,78,79,79,79,79,80,80,81,81,81,82,82,82,83,83,84,84,85,85,
83,83,82,82,82,81,81,80,80,79,79,79,79,78,78,78,78,78,77,77,78,77,77,77,77,77,77,77,77,78,78,78,78,78,79,78,79,79,79,80,80,81,81,82,82,82,83,83,84,84,85,85,
83,83,82,82,82,81,81,80,80,79,79,79,79,78,78,78,78,77,77,77,78,77,77,77,77,77,77,77,77,77,77,78,78,78,78,78,79,79,79,80,80,81,81,81,82,82,83,83,84,84,85,85,
83,83,82,82,81,81,81,80,80,79,79,79,79,78,78,78,78,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,78,78,78,78,79,79,79,80,80,81,81,81,82,82,83,83,84,84,85,85,
83,83,82,82,81,81,80,80,80,79,79,79,79,78,78,78,78,77,77,77,77,77,77,77,77,77,77,77,77,77,77,77,78,77,78,78,78,79,79,79,80,80,80,81,82,82,83,83,84,84,84,85,
83,83,82,82,81,81,80,80,80,79,79,79,79,78,78,77,77,77,77,77,77,77,76,76,76,76,76,77,76,77,77,77,77,77,78,77,78,78,78,79,79,80,80,81,81,81,83,83,83,84,84,85,
83,83,82,82,81,81,80,80,80,79,79,78,78,78,77,77,77,77,76,76,77,76,76,76,76,76,76,76,76,76,76,76,77,77,77,77,78,78,78,79,79,80,80,80,81,81,82,82,83,83,84,84
};

const short OFILM_4RCF_SPEC[TX_NUM] = {
1782,1989,2011,2014,2011,2000,1997,1992,1989,1986,1996,1993,1989,1984,1981,1977,1971,1964,1939,1931,1929,1941,1942,1944,1944,1943,1929,1927,1927,1924,1922,1824
};

const short OFILM_EOP_SPEC[RX_NUM] = {
1570,1731,1700,1725,1700,1714,1692,1707,1690,1703,1681,1693,1680,1687,1670,1687,1666,1679,1659,1667,1648,1662,1645,1662,1643,1650,1632,1650,1630,1639,1630,1631,1624,1625,1624,1627,1609,1617,1603,1608,1601,1596,1593,1597,1589,1594,1581,1588,1574,1577,1575,1490
};

const short ISTXXXX_4RC_TYPICAL = 1400;

void istxxxx_test_mode(struct ist510e *ts)
{
    unsigned char *buf;
    short *framebuf;
    short *tempframe;
	unsigned char r,t,retry;
    int ret = 0;
	unsigned int resultCNT;
	unsigned int vendor;


    buf = kmalloc(sizeof(buf)*TX_NUM*RX_NUM*2+HIDEEP_IMAGE_HEAD_LEN*2, GFP_KERNEL);
    if(buf ==NULL)
    {
        ts_log_err("can't not memmory alloc\n");
        goto exit_buf_alloc_istxxxx_test_mode;
    }
    ist_load_dwz(ts);
    vendor = ts->dwz_info.factory_id;
    
    framebuf = kmalloc(sizeof(framebuf)*TX_NUM*RX_NUM+HIDEEP_IMAGE_HEAD_LEN*2, GFP_KERNEL);
    if(framebuf ==NULL)
    {
        ts_log_err("can't not memmory alloc\n");
        goto exit_framebuf_alloc_istxxxx_test_mode;
    }
  	

    tempframe = kmalloc(sizeof(tempframe)*TX_NUM*RX_NUM+HIDEEP_IMAGE_HEAD_LEN*2, GFP_KERNEL);
    if(tempframe ==NULL)
    {
        ts_log_err("can't not memmory alloc\n");
        goto exit_tempframe_alloc_istxxxx_test_mode;
    }

	//4RCF
	ist_reset_ic();
	mdelay(ISTCORE_RESET_IC_DELAY);
	buf[0] = HIDEEP_IMAGE_CMD_4RCF;
	ret = istcore_i2c_write(ts,TEST_MODE_COMMAND_ADDR, 1, buf);
	ts_log_info("ret = %d\n", ret);
	mdelay(ISTXXXX_IMAGE_DELAY);
	retry =HIDEEP_SELFTEST_RETRY_TIME;
	do{
		ret = istcore_i2c_read(ts, VR_ADDR_IMAGE, (TX_NUM*RX_NUM)*2+HIDEEP_IMAGE_HEAD_LEN*2, (unsigned char *)framebuf);
		if(*((unsigned char *)framebuf)=='G')
		    break;
		mdelay(ISTXXXX_IMAGE_DELAY);
		retry--;
		ts_log_err("retry = %d\n", retry);
	}while(retry);
	ts_log_info("inspection\n");

	//Inspection
	for(t=0; t<TX_NUM; t++)
	{
		resultCNT = 0;
		for (r=0; r<RX_NUM; r++)
		{
			if( 6 == vendor){
                ts_log_debug("4RC: index = %d, framebuf = %d, GIS_4RCF_SPEC = %d\n", 
                r+t*RX_NUM,
                framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN],
                GIS_4RCF_SPEC[t]);
			
			if ((GIS_4RCF_SPEC[t]*14 < framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10)||framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]<0) // SPEC : +30% // ??
			{
				resultCNT++;
			}
			}else if(1 == vendor){
                ts_log_debug("4RC: index = %d, framebuf = %d, OFILM_4RCF_SPEC = %d\n", 
                r+t*RX_NUM,
                framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN],
                OFILM_4RCF_SPEC[t]);
			
			if ((OFILM_4RCF_SPEC[t]*14 < framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10)||framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]<0) // SPEC : +30% // ??
			{
				resultCNT++;
			}
			}
		}

		if (resultCNT > 0)
		{
			ts->TXshortResult[t] = 1;
			ts_log_debug("TX Channel Short = %d\n", t);
		}
		else
		{
			ts->TXshortResult[t] = 0;
			ts_log_debug("4RCF Pass = %d\n", t);
		}
	}


	//EOP
	ist_reset_ic();
	mdelay(ISTCORE_RESET_IC_DELAY);
	buf[0] = HIDEEP_IMAGE_CMD_EOP;
	//buf[1] = 0x02;
	ret = istcore_i2c_write(ts,TEST_MODE_COMMAND_ADDR, 1, buf);
	ts_log_debug("ret = %d\n", ret);

	mdelay(ISTXXXX_IMAGE_DELAY);
	retry =HIDEEP_SELFTEST_RETRY_TIME;
	do{
		ret = istcore_i2c_read(ts, VR_ADDR_IMAGE, (TX_NUM*RX_NUM)*2+HIDEEP_IMAGE_HEAD_LEN*2, (unsigned char *)framebuf);
		if(*((unsigned char *)framebuf)=='G')
		    break;
		mdelay(ISTXXXX_IMAGE_DELAY);
		retry--;
		ts_log_err("retry = %d\n", retry);
	}while(retry);

	//Inspection
	for(r=0; r<RX_NUM; r++)
	{
		resultCNT = 0;
		for (t=0; t<TX_NUM; t++)
		{
			if( 6 == vendor){
            ts_log_debug("EOP: index = %d, framebuf = %d, GIS_EOP_SPEC = %d\n", 
                r+t*RX_NUM,
                framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN],
                GIS_EOP_SPEC[r]);

			if (GIS_EOP_SPEC[r]*13 < framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10) // SPEC : +20%
			{
				resultCNT++;
			}
			}else if(1 == vendor){
            ts_log_debug("EOP: index = %d, framebuf = %d, OFILM_EOP_SPEC = %d\n", 
                r+t*RX_NUM,
                framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN],
                OFILM_EOP_SPEC[r]);

			if (OFILM_EOP_SPEC[r]*13 < framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10) // SPEC : +20%
			{
				resultCNT++;
			}
				
			}
		}

		if (resultCNT > 0)
		{
			ts->RXshortResult[r] = 1;
			ts_log_debug("RX Channel Short = %d\n", r);
		}
		else
		{
			ts->RXshortResult[r] = 0;
			ts_log_debug("EOP Pass = %d\n", r);
		}
	}



	//4RC
	ist_reset_ic();
	mdelay(ISTCORE_RESET_IC_DELAY);
    buf[0] = HIDEEP_IMAGE_CMD_4RC;
    //buf[1] = 0x00;
    ret = istcore_i2c_write(ts,TEST_MODE_COMMAND_ADDR, 1, buf);
    ts_log_debug("ret = %d\n", ret);

	mdelay(ISTXXXX_IMAGE_DELAY);
	retry =HIDEEP_SELFTEST_RETRY_TIME;
	do{
		ret = istcore_i2c_read(ts, VR_ADDR_IMAGE, (TX_NUM*RX_NUM)*2+HIDEEP_IMAGE_HEAD_LEN*2, (unsigned char *)tempframe);
		if(*((unsigned char *)tempframe)=='G')
		    break;
		mdelay(ISTXXXX_IMAGE_DELAY);
		retry--;
		ts_log_err("retry = %d\n", retry);
	}while(retry);
	//1RC
	ist_reset_ic();
	mdelay(ISTCORE_RESET_IC_DELAY);
	buf[0] = HIDEEP_IMAGE_CMD_1RC;
	//buf[1] = 0x01;
	ret = istcore_i2c_write(ts,TEST_MODE_COMMAND_ADDR, 1, buf);
	ts_log_debug("ret = %d\n", ret);

	mdelay(ISTXXXX_IMAGE_DELAY);
	retry =HIDEEP_SELFTEST_RETRY_TIME;
	do{
		ret = istcore_i2c_read(ts, VR_ADDR_IMAGE, (TX_NUM*RX_NUM)*2+HIDEEP_IMAGE_HEAD_LEN*2, (unsigned char *)framebuf);
		if(*((unsigned char *)framebuf)=='G')
		    break;
		mdelay(ISTXXXX_IMAGE_DELAY);
		retry--;
		ts_log_err("retry = %d\n", retry);
	}while(retry);

	//Calculation CMP 
	for(t=0; t<TX_NUM; t++)
	{
		for (r=0; r<RX_NUM; r++)
		{
			tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN] = tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]>0?tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]:1;
			framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN] = framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*100 / tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN];

            ts_log_debug("CMP: index = %d, framebuf(CMP) = %d, tempframe(4RC) = %d\n", 
                r+t*RX_NUM,
                framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN],
                tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]);
		}
	}	

	//Inspection
	for (r=0; r<RX_NUM; r++)
	{
		if (ts->RXshortResult[r] == 0)
		{
			resultCNT = 0;
			for(t=0; t<TX_NUM; t++)
			{
				if((ISTXXXX_4RC_TYPICAL*7 > tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10)||(tempframe[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]<=1)) // SPEC : -30%
				{
					resultCNT++;
				}
/* 				else
				{
					resultCNT = 0;
				} */
			}
			if (resultCNT > 1)
			{
				ts->RXopenResult[r] = 1;
				ts_log_debug("RX Channel Open = %d\n", r);
			}
			else
			{
				ts->RXopenResult[r] = 0;
				ts_log_debug("RX 4RC Pass = %d\n", r);
			}
		}
		else
		{
			ts->RXopenResult[r] = 0;
			ts_log_debug("Skip to check 4RC RX = %d\n", r);
		}
	}
	

	for(t=0; t<TX_NUM; t++)
	{
		if (ts->TXshortResult[t] == 0)
		{
			resultCNT = 0;
			for (r=0; r<RX_NUM; r++)
			{
			if( 6 == vendor){
				if ((ISTXXXX_GIS_CMP_TYPICAL_SPEC[r+t*RX_NUM]*7 > framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10)&&(ts->RXopenResult[r] == 0)) // SPEC : -20%
				{
					resultCNT++;
				}
			}else if( 1 == vendor){
				if ((ISTXXXX_OFILM_CMP_TYPICAL_SPEC[r+t*RX_NUM]*7 > framebuf[r+t*RX_NUM+HIDEEP_IMAGE_HEAD_LEN]*10)&&(ts->RXopenResult[r] == 0)) // SPEC : -20%
				{
					resultCNT++;
				}
			}
			}
			if (resultCNT > 0)
			{
				ts->TXopenResult[t] = 1;
				ts_log_debug("TX Channel Open = %d\n", t);
			}
			else
			{
				ts->TXopenResult[t] = 0;
				ts_log_debug("TX CMP Pass = %d\n", t);
			}
		}
		else
		{
			ts->TXopenResult[t] = 0;
			ts_log_debug("Skip to check CMP TX = %d\n", t);
		}
	}
	istcore_reset_ic();
	mdelay(100);
	kfree(tempframe);
	kfree(framebuf);
	kfree(buf);
	return;
	
exit_tempframe_alloc_istxxxx_test_mode:
	kfree(framebuf);
exit_framebuf_alloc_istxxxx_test_mode:
	kfree(framebuf);
exit_buf_alloc_istxxxx_test_mode:
	return;
}

